<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HAL Kanban v3 (Shared)</title>
    <style>
        :root {
            --bg-color: #1e1e1e;
            --column-bg: #2d2d2d;
            --card-bg: #3d3d3d;
            --text-color: #e0e0e0;
            --accent-color: #ff4d4d; /* HAL Red */
            --highlight-color: #4CAF50;
            --border-radius: 8px;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            height: 100vh;
            box-sizing: border-box;
        }
        h1 { margin: 0 0 20px 0; color: var(--accent-color); display: flex; align-items: center; gap: 10px; }
        .controls { display: flex; gap: 10px; margin-bottom: 20px; align-items: center; }
        button {
            background-color: var(--card-bg);
            border: 1px solid #555;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }
        button:hover { background-color: #555; }
        button.active { background-color: var(--accent-color); border-color: var(--accent-color); }
        
        .board {
            display: flex;
            gap: 20px;
            overflow-x: auto;
            flex-grow: 1;
            padding-bottom: 20px;
        }
        .column {
            background-color: var(--column-bg);
            min-width: 300px;
            width: 300px;
            border-radius: var(--border-radius);
            padding: 10px;
            display: flex;
            flex-direction: column;
        }
        .column-header {
            font-weight: bold;
            margin-bottom: 10px;
            padding: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .task-list {
            flex-grow: 1;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .card {
            background-color: var(--card-bg);
            padding: 10px;
            border-radius: 4px;
            cursor: grab;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            border-left: 4px solid transparent;
            position: relative;
        }
        .card:active { cursor: grabbing; }
        .card.priority-high { border-left-color: #ff4444; }
        .card.priority-medium { border-left-color: #ffbb33; }
        .card.priority-low { border-left-color: #00C851; }
        
        .card-title { font-weight: 500; margin-bottom: 5px; }
        .card-meta { display: flex; justify-content: space-between; font-size: 0.8em; color: #aaa; margin-top: 8px; }
        .badge { padding: 2px 6px; border-radius: 3px; background: #555; font-size: 0.75em; }
        .badge-hal { background: #673AB7; } /* Purple for HAL */
        
        .add-task-form { margin-top: 10px; display: flex; flex-direction: column; gap: 5px; background: #333; padding: 10px; border-radius: 4px; }
        input, select, textarea {
            background: #444; border: 1px solid #555; color: white; padding: 6px; border-radius: 3px;
        }
        
        /* Modal */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background: var(--column-bg); padding: 20px; border-radius: 8px; width: 400px;
            display: flex; flex-direction: column; gap: 10px;
        }
    </style>
</head>
<body>

    <h1>ðŸ”´ HAL Project Board <span style="font-size:0.5em; opacity:0.6;">v3 (Shared)</span></h1>

    <div class="controls">
        <button id="refreshBtn">ðŸ”„ Refresh</button>
        <button onclick="toggleFilter('today')" id="btnToday">ðŸ“… Today Only</button>
        <button onclick="toggleFilter('randy')" id="btnRandy">ðŸ‘¤ Randy</button>
        <button onclick="toggleFilter('hal')" id="btnHAL">ðŸ¤– HAL</button>
        <span style="flex-grow:1"></span>
        <span id="status">Connecting...</span>
    </div>

    <div class="board" id="board">
        <!-- Columns generated by JS -->
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <h3>Edit Task</h3>
            <input type="text" id="editTitle">
            <textarea id="editDesc" rows="3"></textarea>
            <select id="editPriority">
                <option value="high">ðŸ”´ High</option>
                <option value="medium">ðŸŸ¡ Medium</option>
                <option value="low">ðŸŸ¢ Low</option>
            </select>
            <select id="editAssignee">
                <option value="both">Both</option>
                <option value="Randy">ðŸ‘¤ Randy</option>
                <option value="HAL">ðŸ¤– HAL</option>
            </select>
            <input type="date" id="editDate">
            <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:10px;">
                <button onclick="deleteTask()">ðŸ—‘ Delete</button>
                <button onclick="closeModal()">Cancel</button>
                <button onclick="saveEdit()" style="background:var(--accent-color)">Save</button>
            </div>
        </div>
    </div>

<script>
    const API_URL = ''; // Relative URL for portability (works on localhost, LAN, Tailscale)
    let boardData = { columns: [], archive: [] };
    let currentFilter = { today: false, assignee: null };
    let editingTaskId = null;
    let editingColumnId = null;

    // --- Data Sync ---

    async function loadData() {
        document.getElementById('status').textContent = 'Syncing...';
        try {
            const res = await fetch(`${API_URL}/data`);
            if (!res.ok) throw new Error('Failed to load');
            boardData = await res.json();
            renderBoard();
            document.getElementById('status').textContent = 'âœ… Synced';
        } catch (e) {
            console.error(e);
            document.getElementById('status').textContent = 'âŒ Offline (Run server script)';
        }
    }

    async function saveData() {
        document.getElementById('status').textContent = 'Saving...';
        try {
            await fetch(`${API_URL}/data`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(boardData)
            });
            document.getElementById('status').textContent = 'âœ… Saved';
        } catch (e) {
            console.error(e);
            document.getElementById('status').textContent = 'âŒ Save Failed';
        }
    }

    async function syncToCalendar(task) {
        if (!task.dueDate) return;
        try {
            await fetch(`${API_URL}/calendar`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(task)
            });
        } catch (e) {
            console.error("Calendar sync failed", e);
        }
    }

    // --- Rendering ---

    function renderBoard() {
        const board = document.getElementById('board');
        board.innerHTML = '';

        boardData.columns.forEach(col => {
            const colEl = document.createElement('div');
            colEl.className = 'column';
            colEl.innerHTML = `
                <div class="column-header">
                    ${col.title} <span style="opacity:0.5">${col.tasks.length}</span>
                </div>
                <div class="task-list" id="${col.id}" ondrop="drop(event)" ondragover="allowDrop(event)">
                    <!-- Tasks go here -->
                </div>
                ${col.id === 'backlog' || col.id === 'todo' || col.id === 'ideas' ? renderAddForm(col.id) : ''}
            `;
            
            const listEl = colEl.querySelector('.task-list');
            
            // Sort by priority
            const priorityOrder = { high: 0, medium: 1, low: 2 };
            const sortedTasks = [...col.tasks].sort((a,b) => priorityOrder[a.priority] - priorityOrder[b.priority]);

            sortedTasks.forEach(task => {
                if (shouldShow(task)) {
                    listEl.appendChild(createCard(task, col.id));
                }
            });

            board.appendChild(colEl);
        });
    }

    function createCard(task, colId) {
        const div = document.createElement('div');
        div.className = `card priority-${task.priority}`;
        div.draggable = true;
        div.ondragstart = (e) => drag(e, task.id, colId);
        div.onclick = () => openEdit(task.id, colId); // Simple edit trigger

        const isOverdue = task.dueDate && new Date(task.dueDate) < new Date().setHours(0,0,0,0);
        const dateDisplay = task.dueDate ? `<span style="${isOverdue ? 'color:#ff4444' : ''}">ðŸ“… ${task.dueDate}</span>` : '';
        const assigneeBadge = task.assignee !== 'both' ? `<span class="badge ${task.assignee === 'HAL' ? 'badge-hal' : ''}">${task.assignee}</span>` : '';

        div.innerHTML = `
            <div class="card-title">${task.title}</div>
            <div style="font-size:0.8em; color:#888">${task.description || ''}</div>
            <div class="card-meta">
                ${dateDisplay}
                ${assigneeBadge}
            </div>
        `;
        return div;
    }

    function renderAddForm(colId) {
        return `
            <div class="add-task-form">
                <input type="text" id="input-${colId}" placeholder="+ Add item...">
                <div style="display:flex; gap:5px">
                    <select id="prio-${colId}" style="width:70px">
                        <option value="high">High</option>
                        <option value="medium" selected>Med</option>
                        <option value="low">Low</option>
                    </select>
                    <button onclick="addTask('${colId}')" style="flex-grow:1">Add</button>
                </div>
            </div>
        `;
    }

    // --- Logic ---

    function shouldShow(task) {
        if (currentFilter.today) {
            const today = new Date().toISOString().split('T')[0];
            if (task.dueDate !== today) return false;
        }
        if (currentFilter.assignee) {
            if (task.assignee !== 'both' && task.assignee !== currentFilter.assignee) return false;
        }
        return true;
    }

    function addTask(colId) {
        const input = document.getElementById(`input-${colId}`);
        const prio = document.getElementById(`prio-${colId}`);
        const title = input.value.trim();
        if (!title) return;

        const newTask = {
            id: 't' + Date.now(),
            title: title,
            priority: prio.value,
            assignee: 'both',
            dueDate: '',
            description: ''
        };

        const col = boardData.columns.find(c => c.id === colId);
        col.tasks.push(newTask);
        input.value = '';
        saveData();
        renderBoard();
    }

    // --- Drag & Drop ---

    function allowDrop(ev) { ev.preventDefault(); }
    function drag(ev, taskId, colId) {
        ev.dataTransfer.setData("text/plain", JSON.stringify({taskId, colId}));
    }
    function drop(ev, targetColId) { // Simplified drop (append to list)
        ev.preventDefault();
        // Traverse up to find the column div ID if dropped on a child
        let target = ev.target;
        while (target && !target.classList.contains('task-list')) {
            target = target.parentElement;
        }
        if (!target) return;
        const finalColId = target.id;

        const data = JSON.parse(ev.dataTransfer.getData("text/plain"));
        moveTask(data.taskId, data.colId, finalColId);
    }

    function moveTask(taskId, fromColId, toColId) {
        if (fromColId === toColId) return;

        const fromCol = boardData.columns.find(c => c.id === fromColId);
        const toCol = boardData.columns.find(c => c.id === toColId);
        const taskIdx = fromCol.tasks.findIndex(t => t.id === taskId);
        
        if (taskIdx > -1) {
            const [task] = fromCol.tasks.splice(taskIdx, 1);
            toCol.tasks.push(task);
            
            // Auto archive if done
            if (toColId === 'done') {
                task.completedAt = new Date().toISOString();
            }
            saveData();
            renderBoard();
        }
    }

    // --- Editing ---

    function openEdit(taskId, colId) {
        const col = boardData.columns.find(c => c.id === colId);
        const task = col.tasks.find(t => t.id === taskId);
        editingTaskId = taskId;
        editingColumnId = colId;

        document.getElementById('editTitle').value = task.title;
        document.getElementById('editDesc').value = task.description;
        document.getElementById('editPriority').value = task.priority;
        document.getElementById('editAssignee').value = task.assignee;
        document.getElementById('editDate').value = task.dueDate;
        
        document.getElementById('editModal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('editModal').style.display = 'none';
        editingTaskId = null;
    }

    function saveEdit() {
        if (!editingTaskId) return;
        const col = boardData.columns.find(c => c.id === editingColumnId);
        const task = col.tasks.find(t => t.id === editingTaskId);

        task.title = document.getElementById('editTitle').value;
        task.description = document.getElementById('editDesc').value;
        task.priority = document.getElementById('editPriority').value;
        task.assignee = document.getElementById('editAssignee').value;
        const newDate = document.getElementById('editDate').value;
        
        if (newDate !== task.dueDate) {
            task.dueDate = newDate;
            syncToCalendar(task);
        }

        saveData();
        renderBoard();
        closeModal();
    }

    function deleteTask() {
        if (!confirm('Delete this task?')) return;
        const col = boardData.columns.find(c => c.id === editingColumnId);
        col.tasks = col.tasks.filter(t => t.id !== editingTaskId);
        saveData();
        renderBoard();
        closeModal();
    }

    // --- Init ---
    document.getElementById('refreshBtn').onclick = loadData;
    
    function toggleFilter(type) {
        if (type === 'today') currentFilter.today = !currentFilter.today;
        if (type === 'randy') currentFilter.assignee = currentFilter.assignee === 'Randy' ? null : 'Randy';
        if (type === 'hal') currentFilter.assignee = currentFilter.assignee === 'HAL' ? null : 'HAL';
        
        // UI updates
        document.getElementById('btnToday').classList.toggle('active', currentFilter.today);
        document.getElementById('btnRandy').classList.toggle('active', currentFilter.assignee === 'Randy');
        document.getElementById('btnHAL').classList.toggle('active', currentFilter.assignee === 'HAL');
        
        renderBoard();
    }

    loadData();
    setInterval(loadData, 30000); // Auto refresh every 30s
</script>
</body>
</html>
